<app-doctor-layout>
<section class="space-y-8" *ngIf="!loading()">
  <h2 class="text-xl font-semibold">Doctor Profile</h2>

  <!-- Profile Info -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="space-y-3 p-4 border rounded">
      <h3 class="font-semibold">Basic Information</h3>
      <label class="block">
        <span class="text-sm">First Name</span>
        <input class="input" [(ngModel)]="profileForm.firstName" />
      </label>
      <label class="block">
        <span class="text-sm">Last Name</span>
        <input class="input" [(ngModel)]="profileForm.lastName" />
      </label>
      <label class="block">
        <span class="text-sm">Specialization</span>
        <input class="input" [(ngModel)]="profileForm.specialization" />
      </label>
      <label class="block">
        <span class="text-sm">Contact Info</span>
        <input class="input" [(ngModel)]="profileForm.contactInfo" />
      </label>
      <label class="block">
        <span class="text-sm">Email</span>
        <input type="email" class="input" [(ngModel)]="profileForm.email" />
      </label>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="block">
          <span class="text-sm">Gender</span>
          <select class="input" [(ngModel)]="profileForm.gender">
            <option [ngValue]="undefined">Select gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm">Consultation Fees</span>
          <input type="number" class="input" [(ngModel)]="profileForm.consultationFees" />
        </label>
      </div>
      <label class="block">
        <span class="text-sm">Address</span>
        <input class="input" [(ngModel)]="profileForm.address" />
      </label>
      <div class="block">
        <span class="text-sm">Languages</span>
        <div class="flex flex-wrap gap-3 mt-1">
          <label *ngFor="let lang of languageOptions" class="inline-flex items-center gap-2">
            <input type="checkbox" [checked]="profileForm.languages?.includes(lang)" (change)="toggleLanguage(lang, $event)" />
            <span>{{ lang }}</span>
          </label>
        </div>
      </div>
      <button class="btn-primary" (click)="saveProfile()">Update Profile</button>
    </div>

    <!-- Profile Image -->
    <div class="space-y-3 p-4 border rounded">
      <h3 class="font-semibold">Profile Image</h3>
      <div class="flex items-center gap-4">
        <!-- Show current image when no preview is selected -->
        <img *ngIf="!profileImagePreviewUrl && profile?.profileImageUrl" [src]="profile.profileImageUrl" alt="Profile" class="w-24 h-24 rounded object-cover border" />

        <!-- Show preview when a new file is selected -->
        <div *ngIf="profileImagePreviewUrl" class="space-y-1">
          <img [src]="profileImagePreviewUrl" alt="Preview" class="w-24 h-24 rounded object-cover border" />
          <p class="text-xs text-gray-400">Preview (not yet uploaded)</p>
        </div>

        <div class="space-y-2">
          <input type="file" (change)="onProfileImageSelected($event)" accept="image/*" />
          <div class="flex items-center gap-2">
            <button class="btn-primary" (click)="uploadSelectedProfileImage()" [disabled]="!selectedProfileImage || uploadingProfileImage">
              {{ uploadingProfileImage ? 'Uploading…' : 'Upload Image' }}
            </button>
            <button class="btn-secondary" (click)="clearProfileImageSelection()" [disabled]="!selectedProfileImage">Cancel</button>
          </div>
          <p class="text-xs text-gray-400">Select an image to preview, then click Upload.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Education -->
  <div class="p-4 border rounded space-y-3">
    <h3 class="font-semibold">Education</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <label class="block">
        <span class="text-sm">Degree</span>
        <input class="input" [(ngModel)]="newEducation.degree" />
      </label>
      <label class="block">
        <span class="text-sm">Institution</span>
        <input class="input" [(ngModel)]="newEducation.institution" />
      </label>
      <label class="block">
        <span class="text-sm">Year</span>
        <input type="number" class="input" [(ngModel)]="newEducation.yearOfCompletion" />
      </label>
    </div>
    <label class="block">
      <span class="text-sm">Details</span>
      <textarea class="input" [(ngModel)]="newEducation.details"></textarea>
    </label>
    <div class="flex items-center gap-2">
      <button class="btn-primary" (click)="submitEducation()">{{ editingEducationId ? 'Update Education' : 'Add Education' }}</button>
      <button class="btn-secondary" *ngIf="editingEducationId" (click)="cancelEditEducation()">Cancel</button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-separate border-spacing-y-2">
        <thead>
          <tr class="text-gray-400">
            <th class="text-left w-16">Sr No</th>
            <th class="text-left">Degree</th>
            <th class="text-left">Institution</th>
            <th class="text-left w-36">Year of Completion</th>
            <th class="text-left">Details</th>
            <th class="text-left w-40">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let e of educations; index as i" class="border-t">
            <td>{{ i + 1 }}</td>
            <td>{{ e.degree || '—' }}</td>
            <td>{{ e.institution || '—' }}</td>
            <td>{{ e.yearOfCompletion || '—' }}</td>
            <td>{{ e.details || '—' }}</td>
            <td>
              <div class="flex gap-2">
                <button class="btn-secondary" (click)="startEditEducation(e)">Edit</button>
                <button class="btn-danger" (click)="deleteEducation(e)">Delete</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Experience -->
  <div class="p-4 border rounded space-y-3">
    <h3 class="font-semibold">Experience</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <label class="block">
        <span class="text-sm">Hospital</span>
        <input class="input" [(ngModel)]="newExperience.hospitalName" />
      </label>
      <label class="block">
        <span class="text-sm">Position</span>
        <input class="input" [(ngModel)]="newExperience.position" />
      </label>
      <label class="block">
        <span class="text-sm">Years</span>
        <input type="number" class="input" [(ngModel)]="newExperience.yearsOfService" />
      </label>
    </div>
    <label class="block">
      <span class="text-sm">Details</span>
      <textarea class="input" [(ngModel)]="newExperience.details"></textarea>
    </label>
    <div class="flex items-center gap-2">
      <button class="btn-primary" (click)="submitExperience()">{{ editingExperienceId ? 'Update Experience' : 'Add Experience' }}</button>
      <button class="btn-secondary" *ngIf="editingExperienceId" (click)="cancelEditExperience()">Cancel</button>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full text-sm border-separate border-spacing-y-2">
        <thead>
          <tr class="text-gray-400">
            <th class="text-left w-16">Sr No</th>
            <th class="text-left">Hospital</th>
            <th class="text-left">Position</th>
            <th class="text-left w-28">Years</th>
            <th class="text-left">Details</th>
            <th class="text-left w-40">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let x of experiences; index as i" class="border-t">
            <td>{{ i + 1 }}</td>
            <td>{{ x.hospitalName || '—' }}</td>
            <td>{{ x.position || '—' }}</td>
            <td>{{ x.yearsOfService || '—' }}</td>
            <td>{{ x.details || '—' }}</td>
            <td>
              <div class="flex gap-2">
                <button class="btn-secondary" (click)="startEditExperience(x)">Edit</button>
                <button class="btn-danger" (click)="deleteExperience(x)">Delete</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Certificates -->
  <div class="p-4 border rounded space-y-3">
    <h3 class="font-semibold">Certificates</h3>
    <div class="flex items-center gap-3">
      <input type="file" #certFileInput (change)="onCertFileSelected($event)" accept="application/pdf,image/*" />
      <input class="input flex-1" placeholder="Description (optional)" [(ngModel)]="certDescription" />
      <button class="btn-secondary" (click)="uploadCertificate()" [disabled]="uploadingCertificate || !certFile">
        {{ uploadingCertificate ? 'Uploading…' : 'Upload & Create' }}
      </button>
    </div>
    <!-- Upload success banner -->
    <div *ngIf="certUploadMessage" class="p-3 rounded border border-green-700 bg-green-900/40 text-green-100 text-sm space-y-1">
      <div>{{ certUploadMessage }}</div>
      <div class="flex gap-3">
        <a *ngIf="certUploadDetails?.cloudinaryUrl" [href]="certUploadDetails?.cloudinaryUrl" target="_blank" class="link">Open Cloudinary</a>
        <a *ngIf="certUploadDetails?.downloadUrl" [href]="certUploadDetails?.downloadUrl" target="_blank" class="link">Download</a>
        <span *ngIf="certUploadDetails?.filename">File: {{ certUploadDetails?.filename }}</span>
      </div>
    </div>
    <!-- Post-upload metadata form (shown below upload when file created successfully) -->
    <div *ngIf="lastUploadedCertId as nid" class="p-3 rounded border border-gray-700 bg-gray-900/40 space-y-2">
      <div class="font-medium">Complete certificate details</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2" *ngIf="findCert(nid) as newCert">
        <input class="input" placeholder="Name" [(ngModel)]="certEdit[nid].name" />
        <input class="input" placeholder="Issuing Organization" [(ngModel)]="certEdit[nid].issuingOrganization" />
        <input class="input" type="date" placeholder="Issue Date" [(ngModel)]="certEdit[nid].issueDate" />
        <input class="input" type="date" placeholder="Expiry Date" [(ngModel)]="certEdit[nid].expiryDate" />
        <input class="input" placeholder="Credential ID" [(ngModel)]="certEdit[nid].credentialId" />
        <input class="input" placeholder="Credential URL" [(ngModel)]="certEdit[nid].credentialUrl" />
        <textarea class="input md:col-span-2" placeholder="Details" [(ngModel)]="certEdit[nid].details"></textarea>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn-primary" (click)="saveCertificateMeta(findCert(nid))">Save</button>
        <button class="btn-secondary" (click)="cancelNewCertMeta()">Cancel</button>
      </div>
    </div>
    <div *ngIf="(certificates?.length || 0) === 0" class="text-gray-400">No certificates available.</div>
    <!-- Above-table edit form (opens when clicking Edit on a row) -->
    <div *ngIf="editingCertId as eid" class="p-3 rounded border border-gray-700 bg-gray-900/40 space-y-2">
      <div class="font-medium">Edit certificate details</div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2" *ngIf="findCert(eid) as editCert">
        <input class="input" placeholder="Name" [(ngModel)]="certEdit[eid].name" />
        <input class="input" placeholder="Issuing Organization" [(ngModel)]="certEdit[eid].issuingOrganization" />
        <input class="input" type="date" placeholder="Issue Date" [(ngModel)]="certEdit[eid].issueDate" />
        <input class="input" type="date" placeholder="Expiry Date" [(ngModel)]="certEdit[eid].expiryDate" />
        <input class="input" placeholder="Credential ID" [(ngModel)]="certEdit[eid].credentialId" />
        <input class="input" placeholder="Credential URL" [(ngModel)]="certEdit[eid].credentialUrl" />
        <textarea class="input md:col-span-2" placeholder="Details" [(ngModel)]="certEdit[eid].details"></textarea>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn-primary" (click)="saveCertificateMeta(findCert(eid))">Save</button>
        <button class="btn-secondary" (click)="cancelEditCert()">Cancel</button>
      </div>
    </div>

    <div *ngIf="(certificates?.length || 0) > 0" class="overflow-x-auto">
      <table class="w-full text-sm border-separate border-spacing-y-2">
        <thead>
          <tr class="text-gray-400">
            <th class="text-left">Name</th>
            <th class="text-left w-28">Cloudinary</th>
            <th class="text-left w-28">Credential</th>
            <th class="text-left w-52">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of certificates" class="border-t">
            <td>
              <div>{{ c.name || c.originalFilename || 'Certificate' }}</div>
            </td>
            <td>
              <a *ngIf="c.url" class="link" [href]="c.url" target="_blank">View</a>
            </td>
            <td>
              <a *ngIf="c.credentialUrl" class="link" [href]="c.credentialUrl" target="_blank">Verify</a>
            </td>
            <td>
              <div class="flex gap-2">
                <button class="btn-secondary" (click)="startEditCert(c)">Edit</button>
                <button class="btn-danger" (click)="deleteCertificate(c)">Delete</button>
                <label class="btn-secondary cursor-pointer">
                  Replace
                  <input type="file" class="hidden" (change)="replaceCertificateFile(c, $event)" accept="application/pdf,image/*" />
                </label>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  
</section>

<div *ngIf="loading()" class="p-6 text-center text-gray-400">Loading profile…</div>
<div *ngIf="error()" class="p-6 text-center text-red-500">{{ error() }}</div>

</app-doctor-layout>