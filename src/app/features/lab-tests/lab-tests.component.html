<!-- Doctor Layout for DOCTOR role -->
<app-doctor-layout *ngIf="currentRole() === 'DOCTOR'">
  <div class="max-w-7xl mx-auto px-4">
    <div class="mb-8 text-center">
      <h1 class="text-4xl font-bold text-gray-100 mb-2 flex items-center justify-center">
        <i class="fas fa-flask mr-3"></i>
        Lab Tests Booking
      </h1>
      <p class="text-lg text-gray-400">Select tests and create bookings for patients</p>
    </div>

    <!-- Content goes here -->
    <ng-container *ngTemplateOutlet="labTestsContent"></ng-container>
  </div>
</app-doctor-layout>

<!-- Patient Layout for PATIENT role -->
<app-patient-layout *ngIf="currentRole() === 'PATIENT'">
  <div class="max-w-7xl mx-auto px-4">
    <div class="mb-8 text-center">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <h1 class="text-2xl md:text-4xl font-bold text-gray-100 flex items-center">
          <i class="fas fa-flask mr-2 md:mr-3"></i>
          Lab Tests Booking
        </h1>
        <button (click)="navigateToBooking()"
          class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 md:px-4 md:py-2 text-sm md:text-base rounded-lg transition-colors flex items-center whitespace-nowrap">
          <i class="fas fa-vial mr-2"></i>
          View My Bookings
        </button>
      </div>
      <p class="text-lg text-gray-400">Select and book your lab tests</p>
    </div>

    <!-- Content goes here -->
    <ng-container *ngTemplateOutlet="labTestsContent"></ng-container>
  </div>
</app-patient-layout>

<!-- Lab Tests Content Template -->
<ng-template #labTestsContent>
  <!-- Loading State -->
  <div *ngIf="isLoading()" class="flex flex-col items-center justify-center py-16 text-center">
    <div class="text-blue-400 mb-4">
      <i class="fas fa-spinner fa-spin text-3xl"></i>
    </div>
    <p class="text-lg text-gray-300">Loading lab tests...</p>
  </div>


  <!-- Patient Selection for Doctors -->
  <div *ngIf="currentRole() === 'DOCTOR' && !isLoading()"
    class="mb-6 p-4 bg-gray-800 border border-gray-700 rounded-xl">
    <h3 class="text-lg font-semibold text-gray-100 mb-3 flex items-center">
      <i class="fas fa-user-injured mr-2"></i>
      Select Patient for Booking
    </h3>

    <!-- Loading Patients -->
    <div *ngIf="isLoadingPatients()" class="flex items-center justify-center py-6">
      <div class="text-blue-400 mr-3">
        <i class="fas fa-spinner fa-spin"></i>
      </div>
      <span class="text-gray-300">Loading patients...</span>
    </div>

    <!-- Patient Selection Grid -->
    <div *ngIf="!isLoadingPatients() && patients().length > 0"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      <div *ngFor="let patient of patients()"
        class="p-3 bg-gray-700 border-2 border-gray-600 rounded-lg cursor-pointer transition-all duration-200 hover:border-blue-400 hover:shadow-md"
        [class.border-blue-500]="selectedPatientId() === patient.id"
        [class.bg-gray-600]="selectedPatientId() === patient.id" (click)="selectPatient(patient.id)">

        <div class="flex items-center justify-between">
          <div class="flex-1">
            <h4 class="font-semibold text-gray-100">{{ patient.firstName }} {{ patient.lastName }}</h4>
            <p class="text-sm text-gray-300" *ngIf="patient.email">{{ patient.email }}</p>
            <p class="text-sm text-gray-300" *ngIf="patient.contactInfo">{{ patient.contactInfo }}</p>
          </div>

          <div class="ml-3">
            <div class="w-5 h-5 border-2 border-gray-400 rounded-full transition-all duration-200"
              [class.bg-blue-500]="selectedPatientId() === patient.id"
              [class.border-blue-500]="selectedPatientId() === patient.id">
              <i class="fas fa-check text-white text-xs absolute top-0.5 left-0.5"
                [class.opacity-100]="selectedPatientId() === patient.id"
                [class.opacity-0]="selectedPatientId() !== patient.id"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No Patients Available -->
    <div *ngIf="!isLoadingPatients() && patients().length === 0" class="text-center py-6 text-gray-400">
      <i class="fas fa-user-slash text-2xl mb-2 opacity-50"></i>
      <p class="text-base">No patients available</p>
      <button (click)="loadPatients()"
        class="mt-2 text-blue-600 hover:text-blue-700 hover:underline underline-offset-2 text-sm font-medium px-0 py-0">Refresh</button>
    </div>

    <!-- Selected Patient Display -->
    <div *ngIf="selectedPatientId() && getSelectedPatientName()"
      class="mt-3 p-2 bg-green-900/50 border border-green-700 rounded-lg">
      <div class="flex items-center">
        <i class="fas fa-check-circle text-green-400 mr-2"></i>
        <span class="text-green-300 font-medium">Selected Patient: {{ getSelectedPatientName() }}</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading()" class="pb-32 md:pb-24">
    <!-- Control Panel -->
    <div
      class="flex flex-col md:flex-row items-stretch md:items-center justify-between gap-4 p-4 bg-gray-800/50 border border-gray-700 rounded-xl mb-6 backdrop-blur-sm">
      <div class="flex gap-2 md:gap-3 w-full md:w-auto">
        <button (click)="selectAllTests()"
          class="flex-1 md:flex-none inline-flex items-center justify-center px-3 py-2 md:px-6 md:py-3 bg-gray-700 border border-gray-600 text-gray-200 font-semibold text-sm md:text-base rounded-lg hover:bg-gray-600 hover:border-gray-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          [disabled]="labTests().length === 0">
          <i class="fas fa-check-double mr-2"></i>
          Select All
        </button>

        <button (click)="unselectAllTests()"
          class="flex-1 md:flex-none inline-flex items-center justify-center px-3 py-2 md:px-6 md:py-3 bg-gray-700 border border-gray-600 text-gray-200 font-semibold text-sm md:text-base rounded-lg hover:bg-gray-600 hover:border-gray-500 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          [disabled]="selectedCount() === 0">
          <i class="fas fa-times mr-2"></i>
          Unselect All
        </button>
      </div>

      <!-- Full Body Checkup Toggle -->
      <div class="flex items-center">
        <label class="flex items-center cursor-pointer select-none">
          <input type="checkbox" [checked]="isFullBodyCheckup()" (change)="toggleFullBodyCheckup()" class="sr-only">
          <div class="relative">
            <div class="w-5 h-5 border-2 border-gray-500 rounded mr-3 transition-all duration-200"
              [class.bg-blue-500]="isFullBodyCheckup()" [class.border-blue-500]="isFullBodyCheckup()">
              <i class="fas fa-check text-white text-xs absolute top-0.5 left-0.5"
                [class.opacity-100]="isFullBodyCheckup()" [class.opacity-0]="!isFullBodyCheckup()"></i>
            </div>
          </div>
          <span class="font-medium text-gray-200">
            <i class="fas fa-user-md mr-2"></i>
            Full Body Checkup
          </span>
        </label>
      </div>
    </div>

    <!-- Lab Tests List -->
    <div class="space-y-3" *ngIf="labTests().length > 0">
      <div *ngFor="let test of labTests(); trackBy: trackByTestId"
        class="group border border-gray-700 rounded-xl p-3 md:p-4 transition-all duration-200 cursor-pointer hover:border-blue-500/50 hover:shadow-lg hover:shadow-blue-900/10 active:scale-[0.99]"
        (click)="toggleTestSelection(test.id)" [ngClass]="{
          'bg-blue-900/20 border-blue-500 ring-1 ring-blue-500': isTestSelected(test.id),
          'bg-gray-800': !isTestSelected(test.id)
        }">

        <div class="flex flex-col sm:flex-row sm:items-center gap-2 md:gap-4">
          <!-- Left side: Checkbox and Name -->
          <div class="flex items-start sm:items-center gap-3 flex-1">
            <label class="flex items-center cursor-pointer mt-0.5 sm:mt-0">
              <input type="checkbox" [checked]="isTestSelected(test.id)" (change)="toggleTestSelection(test.id)"
                (click)="$event.stopPropagation()" class="sr-only">
              <div
                class="w-5 h-5 md:w-6 md:h-6 rounded-md border-2 border-gray-600 transition-all duration-200 flex items-center justify-center"
                [class.bg-blue-500]="isTestSelected(test.id)" [class.border-blue-500]="isTestSelected(test.id)"
                [class.group-hover:border-blue-400]="!isTestSelected(test.id)">
                <i class="fas fa-check text-white text-xs md:text-sm transform scale-0 transition-transform duration-200"
                  [class.scale-100]="isTestSelected(test.id)"></i>
              </div>
            </label>

            <div class="flex-1">
              <h3 class="text-sm md:text-lg font-semibold text-gray-100 group-hover:text-blue-200 transition-colors">
                {{ test.testName }}</h3>
              <p class="text-xs text-gray-400 mt-0.5 sm:hidden" *ngIf="test.description">
                {{ test.description }}
              </p>
            </div>
          </div>

          <!-- Right side: Description (Desktop) and Price -->
          <div class="flex items-center justify-between sm:justify-end gap-6 sm:flex-shrink-0 pl-8 sm:pl-0">
            <p class="text-sm text-gray-400 max-w-md hidden sm:block text-right" *ngIf="test.description">
              {{ test.description }}
            </p>
            <div class="text-right">
              <div class="text-base md:text-lg font-bold text-green-400 tracking-wide">{{ formatPrice(test.price) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="labTests().length === 0 && !isLoading()" class="text-center py-16 text-gray-400">
      <i class="fas fa-flask text-5xl mb-6 opacity-50"></i>
      <h3 class="text-2xl font-semibold mb-2 text-gray-200">No Lab Tests Available</h3>
      <p class="text-lg mb-8">There are currently no active lab tests available for booking.</p>
      <button (click)="loadLabTests()"
        class="text-blue-600 hover:text-blue-700 hover:underline underline-offset-2 text-sm font-medium px-0 py-0 inline-flex items-center">
        <i class="fas fa-refresh mr-2"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Fixed Summary Section -->
  <div
    class="fixed bottom-16 md:bottom-0 left-0 right-0 md:left-64 bg-gray-800/95 backdrop-blur-md border-t border-gray-700 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50 transition-all duration-300"
    *ngIf="!isLoading() && labTests().length > 0">
    <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">

      <!-- Stats Row: Active on both mobile and desktop -->
      <div class="flex items-center justify-between w-full sm:w-auto gap-4 sm:gap-8">

        <!-- Selected Count & Price Group -->
        <div class="flex items-center gap-6 sm:gap-8 flex-1 sm:flex-none">
          <div class="flex flex-col items-start">
            <span class="text-[10px] sm:text-xs text-gray-400 uppercase tracking-wide mb-0.5">Selected</span>
            <div class="flex items-baseline gap-1">
              <span class="text-xl sm:text-2xl font-bold text-gray-100">{{ selectedCount() }}</span>
              <span class="text-xs text-gray-500 font-medium">tests</span>
            </div>
          </div>

          <div class="w-px h-8 bg-gray-700 hidden sm:block"></div>

          <div class="flex flex-col items-start">
            <span class="text-[10px] sm:text-xs text-gray-400 uppercase tracking-wide mb-0.5">Total</span>
            <span class="text-xl sm:text-2xl font-bold text-green-400">{{ formatPrice(totalPrice()) }}</span>
          </div>
        </div>

        <!-- Prescribed By (Hidden on very small screens if needed, or stacked) -->
        <div class="hidden sm:flex flex-col items-start border-l border-gray-700 pl-6"
          *ngIf="currentRole() === 'DOCTOR'">
          <span class="text-[10px] sm:text-xs text-gray-400 uppercase tracking-wide mb-0.5">Prescriber</span>
          <span class="text-sm font-semibold text-gray-100 truncate max-w-[150px]">{{ getPrescriberName() }}</span>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 w-full sm:w-auto mt-2 sm:mt-0">
        <button (click)="clearSelections()"
          class="flex-1 sm:flex-none inline-flex items-center justify-center px-4 py-2.5 bg-gray-700 text-gray-200 font-medium rounded-lg hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
          [disabled]="selectedCount() === 0 || isBooking()">
          <i class="fas fa-eraser mr-2 text-xs"></i>
          Clear
        </button>

        <button (click)="bookTests()"
          class="flex-[2] sm:flex-none inline-flex items-center justify-center px-6 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-900/20 text-sm"
          [disabled]="selectedCount() === 0 || isBooking()">
          <i class="fas fa-calendar-plus mr-2" *ngIf="!isBooking()"></i>
          <i class="fas fa-spinner fa-spin mr-2" *ngIf="isBooking()"></i>
          {{ isBooking() ? 'Processing...' : (currentRole() === 'PATIENT' ? 'Proceed to Pay' : 'Book Tests') }}
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- Payment Popup -->
<app-payment-popup *ngIf="showPaymentPopup()" [isVisible]="showPaymentPopup()" [amount]="totalPrice()"
  [title]="'Lab Test Booking - ' + selectedCount() + ' test(s)'" [patientId]="getPatientIdForPayment()"
  [paymentType]="'LAB_TEST'" (paymentSuccess)="onPaymentSuccess($event)" (paymentCancel)="onPaymentCancel()">
</app-payment-popup>